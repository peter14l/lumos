name: Build and Package Lumos MSIX

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
        
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore Lumos.sln
      
    - name: Build Solution (All Projects)
      run: msbuild Lumos.sln /p:Configuration=Release /p:Platform=x64 /v:detailed
      
    - name: Generate self-signed certificate
      run: |
        $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=Lumos" -KeyUsage DigitalSignature -FriendlyName "Lumos Certificate" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
        $password = ConvertTo-SecureString -String "LumosCert2026" -Force -AsPlainText
        $certPath = Join-Path $PWD "LumosCert.pfx"
        Export-PfxCertificate -Cert $cert -FilePath $certPath -Password $password
        Write-Host "Certificate created at: $certPath"
        
    - name: Build MSIX Package
      run: |
        $certPath = Join-Path $PWD "LumosCert.pfx"
        Write-Host "Building MSIX with certificate: $certPath"
        msbuild packaging/Lumos.wapproj /p:Configuration=Release /p:Platform=x64 /p:AppxPackageDir="$PWD\AppPackages\" /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:PackageCertificateKeyFile="$certPath" /p:PackageCertificatePassword=LumosCert2026 /v:detailed
        
    - name: List AppPackages directory
      run: |
        Write-Host "Contents of AppPackages directory:"
        Get-ChildItem -Path AppPackages -Recurse | ForEach-Object { Write-Host $_.FullName }
        
    - name: Sign MSIX Package
      run: |
        $msixPath = Get-ChildItem -Path "AppPackages" -Filter "*.msix" -Recurse | Select-Object -First 1
        if ($msixPath) {
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign /fd SHA256 /f LumosCert.pfx /p LumosCert2026 $msixPath.FullName
          Write-Host "Signed: $($msixPath.FullName)"
        } else {
          Write-Error "MSIX package not found"
          exit 1
        }
        
    - name: Upload MSIX Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Lumos-MSIX
        path: AppPackages/**/*.msix
        
    - name: Upload Certificate (for installation)
      uses: actions/upload-artifact@v4
      with:
        name: Lumos-Certificate
        path: LumosCert.pfx
