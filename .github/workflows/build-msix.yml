name: Build and Package Lumos MSIX

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'
        
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: Restore NuGet packages
      run: nuget restore Lumos.sln
      
    - name: Build C++ Core (core-native)
      run: msbuild core-native/core-native.vcxproj /p:Configuration=Release /p:Platform=x64
      
    - name: Build C# UI (ui-managed)
      run: msbuild ui-managed/ui-managed.csproj /p:Configuration=Release /p:Platform=x64
      
    - name: Decode and import certificate
      run: |
        # Decode base64 certificate from secrets
        $pfxBytes = [System.Convert]::FromBase64String("${{ secrets.SIGNING_CERTIFICATE }}")
        $pfxPath = "LumosCert.pfx"
        [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
        
        Write-Host "Certificate imported from secrets"
        
    - name: Increment Version
      run: |
        $manifestPath = "packaging/Package.appxmanifest"
        [xml]$xml = Get-Content $manifestPath
        $version = [Version]$xml.Package.Identity.Version
        
        # Increment Build (Revision) component: Major.Minor.Build.Revision
        # MSIX uses quad format. We'll increment the 4th digit (Revision) for every build.
        # Alternatively, use GitHub Run Number for a unique increasing ID.
        $newRevision = ${{ github.run_number }}
        $newVersion = "{0}.{1}.{2}.{3}" -f $version.Major, $version.Minor, $version.Build, $newRevision
        
        $xml.Package.Identity.Version = $newVersion
        $xml.Save($manifestPath)
        
        Write-Host "Updated version to $newVersion"

    - name: Prepare MSIX Package Files
      run: |
        # Create package directory structure
        New-Item -ItemType Directory -Force -Path "PackageFiles"
        
        # Copy core executable
        Copy-Item "core-native/bin/x64/Release/core-native.exe" "PackageFiles/" -Force
        
        # Copy UI executable and dependencies from .NET output directory
        $uiOutputPath = "ui-managed/bin/x64/Release/net8.0-windows"
        if (Test-Path $uiOutputPath) {
          Copy-Item "$uiOutputPath/*" "PackageFiles/" -Recurse -Force
          Write-Host "Copied UI files from $uiOutputPath"
        } else {
          Write-Error "UI output path not found: $uiOutputPath"
          exit 1
        }
        
        # Copy manifest with correct name (must be AppxManifest.xml)
        Copy-Item "packaging/Package.appxmanifest" "PackageFiles/AppxManifest.xml" -Force
        
        # Copy assets
        Copy-Item "packaging/Assets" "PackageFiles/" -Recurse -Force
        
        Write-Host "Package files prepared"
        Get-ChildItem "PackageFiles" -Recurse | ForEach-Object { Write-Host $_.FullName }
        
    - name: Create MSIX Package
      run: |
        # Find makeappx.exe in Windows SDK
        $sdkPath = "C:\Program Files (x86)\Windows Kits\10\bin"
        $makeappx = Get-ChildItem -Path $sdkPath -Recurse -Filter "makeappx.exe" -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*\x64\*" } | Select-Object -First 1
        
        if (-not $makeappx) {
          Write-Error "makeappx.exe not found in Windows SDK"
          exit 1
        }
        
        Write-Host "Found makeappx.exe at: $($makeappx.FullName)"
        
        $packageDir = Resolve-Path "PackageFiles"
        $outputMsix = "Lumos_1.0.0.0_x64.msix"
        
        Write-Host "Creating MSIX package..."
        & $makeappx.FullName pack /d $packageDir /p $outputMsix /nv
        
        if (Test-Path $outputMsix) {
          Write-Host "MSIX package created: $outputMsix"
        } else {
          Write-Error "Failed to create MSIX package"
          exit 1
        }
        
    - name: Sign MSIX Package
      run: |
        # Find signtool.exe in Windows SDK
        $sdkPath = "C:\Program Files (x86)\Windows Kits\10\bin"
        $signtool = Get-ChildItem -Path $sdkPath -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*\x64\*" } | Select-Object -First 1
        
        if (-not $signtool) {
          Write-Error "signtool.exe not found in Windows SDK"
          exit 1
        }
        
        Write-Host "Found signtool.exe at: $($signtool.FullName)"
        
        $msixPath = "Lumos_1.0.0.0_x64.msix"
        
        Write-Host "Signing MSIX package..."
        & $signtool.FullName sign /fd SHA256 /f LumosCert.pfx /p "${{ secrets.CERTIFICATE_PASSWORD }}" $msixPath
        
        Write-Host "MSIX package signed successfully"
        
    - name: Upload MSIX Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Lumos-MSIX
        path: Lumos_1.0.0.0_x64.msix
        
    - name: Upload Certificate (for installation)
      uses: actions/upload-artifact@v4
      with:
        name: Lumos-Certificate
        path: LumosCert.pfx
